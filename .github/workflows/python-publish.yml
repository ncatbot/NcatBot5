# name: 构建并发布至 PyPI

# on:
#   workflow_run:
#     workflows: ["预构建检查"]
#     types: [ completed ]
#   workflow_dispatch:

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       # 1. 检出源码
#       - name: 检出源码
#         uses: actions/checkout@v6

#       # 2. 安装 Python 3.13（官方最新 v5）
#       - name: 安装 Python 3.13
#         uses: actions/setup-python@v6
#         with:
#           python-version: "3.13"

#       # 3. 缓存 pip
#       - name: 缓存 pip
#         uses: actions/cache@v5
#         with:
#           path: ~/.cache/pip
#           key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}

#       # 4. 安装构建工具
#       - name: 安装 build 工具
#         run: |
#           python -m pip install --upgrade pip build twine

#       # 5. 构建源码包 + 轮子
#       - name: 构建分发包
#         run: python -m build --sdist --wheel

#       # 6. 上传产物供发布 job 使用
#       - name: 上传构建产物
#         uses: actions/upload-artifact@v6
#         with:
#           name: dist
#           path: dist/

#   publish:
#     needs: build
#     # 只在预构建检查成功且为 main 分支时才发布，或允许手动触发
#     if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') || github.event_name == 'workflow_dispatch' }}
#     runs-on: ubuntu-latest
#     steps:
#       # 1. 下载构建产物（无需再次检出）
#       - name: 下载构建产物
#         uses: actions/download-artifact@v7
#         with:
#           name: dist
#           path: dist/

#       # 2. 安装 Python & twine
#       - name: 安装 Python 3.13
#         uses: actions/setup-python@v6
#         with:
#           python-version: "3.13"

#       - name: 安装 twine
#         run: python -m pip install --upgrade pip twine

#       # 3. 发布到 PyPI
#       - name: 发布至 PyPI
#         env:
#           TWINE_USERNAME: __token__
#           TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
#         run: twine upload dist/*
